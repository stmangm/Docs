# Docs
DocAsCode
# BPL-2090 Разовое формирование Заявлений на выдачу ЭЦП в HAOS, по которым отсутствуют Заявления

## Техническое задание на разработку скрипта для обработки данных сертификатов

1. Введение

Описание: создание и выполнение скрипта для обработки данных из файла и формирования заявлений на основании активных сертификатов, полученных из удаленного сервиса.

2. Цели

* Извлечение информации из файла.
* Получение данных о сертификатах из сервиса https://apps.ocp-p.bank.kz/api/v1/users/:user-id/certificates.
* Формирование заявлений на основании извлеченных данных и данных сертификатов используя сервис maquete.
* Логирование процесса обработки и ошибок.

3. Входные данные

* Файл с данными:
  * Поля: iin, mobile_phone_number.
  * Формат файла (CSV).
* URL сервиса: https://apps.ocp-p.bank.kz/api/v1/users/:user-id/certificates.

4. Алгоритм
                               
1. Инициализация:
    * Чтение входного файла.
    * Настройка логирования (уровень детализации).
2. Итерация по записям файла:
    * Для каждой записи:
        * Извлечение значения iin и mobile_phone_number.
        * Формирование URL запроса к сервису, подставляя iin в качестве user-id, cert_status = ACTIVE
        * Отправка GET запроса к сервису.
        * Обработка ответа:
            * Успешный ответ (200 OK):
                * Проверка наличия активных сертификатов в ответе.
                * Для каждого активного сертификата:
                    * Проверка issueDate (Unix timestamp) сертификата: issueDate < 05.03.2025 (не включительно).
                    * Если сертификат подходит:
                        * Извлечение значений:
                            * FIO (из certificate.Subject.CN).
                            * IIN (из certificate.Subject.SERIALNUMBER).
                            * Дата выпуска (из issueDate, преобразовать из Unix timestamp).
                        * Формирование "Заявления":
                            * {{IIN}} = "Сертификат.Субъект.SERIALNUMBER" без букв IIN.
                            * {{FIO}} = "Сертификат.Субъект.CN".
                            * {{Phone}} = "файл.mobile_phone_number".
                            * {{Year}} = "один год", статичное значение
                            * {{PublicKey}} = ответ сервиса "result.certificateEncoded" - первые 5 символов + "..." + последние 5 символов.
                            * {{ActualDate}} = "Сертификат.Субъект.CN".
                        * Логирование успешного формирования заявления сервисом Maquete. Doctype = df2ab060-68ba-4863-a4e6-af6be6984973
                    * Если сертификат не подходит (дата выпуска >= 05.03.2025), логирование причины.
            * Ошибка 404 (Not Found): Логирование информации об iin и mobile_phone_number и сообщения об ошибке.
            * Другие ошибки:  Логирование ошибки с детальным описанием (например, ошибка сети, неверный формат ответа).
3. Завершение:  Сохранение сформированных заявлений в указанном формате.

5. Обработка ошибок

* Обработка ошибок сети (timeout, connection refused).
* Обработка ошибок валидации ответа сервиса (неверный формат JSON, отсутствующие поля).
* Обработка ошибок преобразования данных (например, преобразование Unix timestamp в дату).
* Регистрация ошибок в лог-файле с указанием подробной информации (тип ошибки, значение iin, mobile_phone_number, текст ошибки).

6. Логирование

* Уровень детализации: INFO.
* Логируемая информация:
  * Начало и конец обработки файла.
  * Обработка каждой записи (значения iin и mobile_phone_number).
  * UUID //при успешном формировании Заявления
  * Сообщения об ошибках.
* По окончании работы скрипта сформировать файл с результатами работы скрипта

7. Выходные данные
* Формат выходных данных ("Заявление"):  Сформированный документ в HAOS.
* Лог-файл с информацией о процессе обработки.
  * Структура файла результата обработки:
    * iin
    * mobile_phone_number
    * UUID //при успешном формировании Заявления
    * MSG  // при отсутствии активного сертификата/пользователя и другие ошибки

Дополнительно:

* Запуск скрипта в ночное время дли минимизации нагрузки на инфраструктуру.
* При падении или прерывании работы скрипт не должен брать в обработку ранее обработанные записи.
* Файл содержит большое кол-во записей, более 2 миллионов, следует применить потоковую обработку (без фанатизма см пункт 1), чтобы избежать переполнения памяти.

@startuml

!theme plain

title Обработка файла и формирование заявлений

start

:Чтение входного файла;

:Инициализация логирования;

:Итерация по записям файла;

fork
    :Извлечение IIN и Mobile Phone;
    :Формирование URL запроса к API;
    :Отправка GET запроса к API;

    if (Сертификат активен и дата выпуска < 05.03.2025) then (Да)
        :Извлечение данных сертификата (FIO, IIN, Дата выпуска);
        :Формирование "Заявления";
        :Логирование успешного формирования заявления;
    else (Нет)
        :Логирование причины отказа;
    endif

    if (Ошибка) then (Да)
       :Логирование ошибки и IIN/Mobile Phone;
    else (Нет)
        :Итерация по записям файла;
    endif

end fork

:Завершение обработки;

stop
@enduml
